"use strict";(self.webpackChunkmy_blog=self.webpackChunkmy_blog||[]).push([[9852],{5386:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>a,frontMatter:()=>r,metadata:()=>i,toc:()=>d});var s=t(4848),l=t(8453);const r={title:"ubuntu\u7684vpn\u9023\u7dda",authors:"ttom",tags:["ubuntu","vpn"]},o="L2TP/Ipsec\u9023\u7dda",i={permalink:"/my-blog/blog/\u8a18\u9304/ubuntu/ubuntuvpn",source:"@site/blog/\u8a18\u9304/ubuntu/ubuntuvpn.md",title:"ubuntu\u7684vpn\u9023\u7dda",description:"\u5728ubuntu\u4e0b\u4f86\u5efa\u7acbVPN,\u6ce8\u610f\u672a\u6210\u529f",date:"2024-03-27T03:48:57.000Z",tags:[{label:"ubuntu",permalink:"/my-blog/blog/tags/ubuntu"},{label:"vpn",permalink:"/my-blog/blog/tags/vpn"}],readingTime:2.38,hasTruncateMarker:!0,authors:[{name:"tom tang",title:"Soft Engineer",url:"https://github.com/ttom921",imageURL:"https://github.com/ttom921.png",key:"ttom"}],frontMatter:{title:"ubuntu\u7684vpn\u9023\u7dda",authors:"ttom",tags:["ubuntu","vpn"]},unlisted:!1,prevItem:{title:"FlexBox\u76f8\u95dc",permalink:"/my-blog/blog/\u8a18\u9304/frontend/flexbox"},nextItem:{title:"Welcome",permalink:"/my-blog/blog/welcome"}},c={authorsImageUrls:[void 0]},d=[{value:"\u76ee\u524d\u5ba2\u6236\u662f\u4f7f\u7528l2tp\u4f86\u9023\u7dda\uff0c\u6240\u4f86\u9996\u5148\u4ee5windown\u5167\u5efa\u4e00vpn\u4f86\u9023\u7dda\u6e2c\u8a66\u9023\u7dda\u662f\u5426\u6b63\u5e38\n\u5b89\u88dd\u5957\u4ef6",id:"\u76ee\u524d\u5ba2\u6236\u662f\u4f7f\u7528l2tp\u4f86\u9023\u7dda\u6240\u4f86\u9996\u5148\u4ee5windown\u5167\u5efa\u4e00vpn\u4f86\u9023\u7dda\u6e2c\u8a66\u9023\u7dda\u662f\u5426\u6b63\u5e38\u5b89\u88dd\u5957\u4ef6",level:2},{value:"Configure StrongSwan",id:"configure-strongswan",level:2},{value:"\u8a2d\u5b9axl2tpd",id:"\u8a2d\u5b9axl2tpd",level:2},{value:"\u7de8\u8f2f options.l2tpd.client:",id:"\u7de8\u8f2f-optionsl2tpdclient",level:2},{value:"\u9023\u7dda",id:"\u9023\u7dda",level:2},{value:"Route",id:"route",level:2},{value:"\u65b7\u7dda",id:"\u65b7\u7dda",level:2},{value:"Debugging",id:"debugging",level:2},{value:"\u53c3\u8003\u6587\u4ef6",id:"\u53c3\u8003\u6587\u4ef6",level:6}];function p(e){const n={a:"a",code:"code",h2:"h2",h6:"h6",p:"p",pre:"pre",...(0,l.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.p,{children:"\u5728ubuntu\u4e0b\u4f86\u5efa\u7acbVPN,\u6ce8\u610f\u672a\u6210\u529f"}),"\n",(0,s.jsx)(n.p,{children:"\u56e0\u70ba\u516c\u53f8\u7684\u5ba2\u6236\u4f7fVPN\u4f86\u9023\u7dda\uff0c\u6240\u4ee5\u5728jenins\u7684\u4e3b\u6a5f\u4e5f\u8981\u4f86\u8a2d\u5b9a\u4e00\u4e0b\uff0c\u53ef\u4ee5\u76f4\u63a5\u9023\u7dda\u4f86\u66f4\u65b0web\u7684code\u548c\u670d\u52d9\u5668\u4e0a\u7684code"}),"\n",(0,s.jsx)(n.h2,{id:"\u76ee\u524d\u5ba2\u6236\u662f\u4f7f\u7528l2tp\u4f86\u9023\u7dda\u6240\u4f86\u9996\u5148\u4ee5windown\u5167\u5efa\u4e00vpn\u4f86\u9023\u7dda\u6e2c\u8a66\u9023\u7dda\u662f\u5426\u6b63\u5e38\u5b89\u88dd\u5957\u4ef6",children:"\u76ee\u524d\u5ba2\u6236\u662f\u4f7f\u7528l2tp\u4f86\u9023\u7dda\uff0c\u6240\u4f86\u9996\u5148\u4ee5windown\u5167\u5efa\u4e00vpn\u4f86\u9023\u7dda\u6e2c\u8a66\u9023\u7dda\u662f\u5426\u6b63\u5e38\n\u5b89\u88dd\u5957\u4ef6"}),"\n",(0,s.jsx)(n.p,{children:"sudo ike-scan chexxx.com.tw --sport=0"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"sudo apt-get update\nsudo apt-get install xl2tpd\nsudo apt-get install strongswan\n"})}),"\n",(0,s.jsx)(n.h2,{id:"configure-strongswan",children:"Configure StrongSwan"}),"\n",(0,s.jsx)(n.p,{children:"\u7de8\u8f2f ipsec.conf:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"sudo vim /etc/ipsec.conf\n"})}),"\n",(0,s.jsx)(n.p,{children:"\u8ffd\u52a0\u5167\u5bb9\u5728\u5f8c\u9762,\u5c07n.n.n.n\u662fVPN server\u7684IP"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-conf",children:"\nconn %default\n    ikelifetime=60m\n    keylife=20m\n    rekeymargin=3m\n    keyingtries=1\n    keyexchange=ikev1\n    authby=secret\n    ike=aes128-sha1-modp1024,3des-sha1-modp1024!\n    esp=aes128-sha1-modp1024,3des-sha1-modp1024!\n\nconn L2TP-PSK\n    keyexchange=ikev1\n    left=%defaultroute\n    auto=add\n    authby=secret\n    type=transport\n    leftprotoport=17/1701\n    rightprotoport=17/1701\n    # set this to the ip address of your vpn server\n    right=n.n.n.n\n\n\n\n"})}),"\n",(0,s.jsx)(n.p,{children:"\u7de8\u8f2f\u9019\u6a94\u6848\u662f\u653e\u91d1\u9470\u7684\u5730\u65b9 ipsec.secrets:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"sudo vim /etc/ipsec.secrets\n"})}),"\n",(0,s.jsxs)(n.p,{children:["\u653e\u5728",(0,s.jsx)(n.code,{children:"your_pre_shared_key"}),"\u7684\u653e\u91d1\u9470\u7684\u5730\u65b9"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:': PSK "your_pre_shared_key"\n'})}),"\n",(0,s.jsx)(n.h2,{id:"\u8a2d\u5b9axl2tpd",children:"\u8a2d\u5b9axl2tpd"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"sudo vim /etc/xl2tpd/xl2tpd.conf\n"})}),"\n",(0,s.jsx)(n.p,{children:"\u8ffd\u52a0\u4ee5\u4e0b\u7684\u5167\u5bb9\uff0c\u5c07n.n.n.n\u7528\u4f60\u7684VPN server IP\u7684\u4ee3\u66ff"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"[lac cpcVPN]\n; set this to the ip address of your vpn server\nlns = n.n.n.n\nppp debug = yes\npppoptfile = /etc/ppp/options.l2tpd.client\nlength bit = yes\n\n"})}),"\n",(0,s.jsx)(n.h2,{id:"\u7de8\u8f2f-optionsl2tpdclient",children:"\u7de8\u8f2f options.l2tpd.client:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"sudo vim /etc/ppp/options.l2tpd.client\n\n"})}),"\n",(0,s.jsxs)(n.p,{children:["\u52a0\u5165\u4e0b\u5217\u7684\u5167\u5bb9\u5c07",(0,s.jsx)(n.code,{children:"your_user_name"}),"\u548c ",(0,s.jsx)(n.code,{children:"your_password"}),"\u4ee3\u66ff"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"ipcp-accept-local\nipcp-accept-remote\nrefuse-eap\nrequire-mschap-v2\nnoccp\nnoauth\nlogfile /var/log/xl2tpd.log\nidle 1800\nmtu 1410\nmru 1410\ndefaultroute\nusepeerdns\ndebug\nconnect-delay 5000\nname your_user_name\npassword your_password\n\n"})}),"\n",(0,s.jsx)(n.h2,{id:"\u9023\u7dda",children:"\u9023\u7dda"}),"\n",(0,s.jsx)(n.p,{children:"\u6bcf\u6b21\u9023\u7dda\u6642\u8981\u57f7\u884c\u4e0b\u5217\u7684\u547d\u4ee4"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"sudo mkdir -p /var/run/xl2tpd\nsudo touch /var/run/xl2tpd/l2tp-control\nsudo service strongswan-starter restart\nsudo service xl2tpd restart\nsudo service ipsec restart\nsleep 8\nsudo ipsec up L2TP-PSK\nsleep 8\nsudo bash -c 'echo \"c cpcVPN\" > /var/run/xl2tpd/l2tp-control'\nsleep 8\nifconfig\n"})}),"\n",(0,s.jsx)(n.p,{children:"\u6aa2\u67e5\u8f38\u51fa\u662f\u5426\u6709interface ppp0\uff0c\u6709\u7684\u8a71\u4e0b\u4e00\u6b65\u624d\u80fd\u9032\u884c"}),"\n",(0,s.jsx)(n.h2,{id:"route",children:"Route"}),"\n",(0,s.jsxs)(n.p,{children:["\u5c07vpn\u7684IP\u52a0\u5165rout\u8868\u88cf,\u5c07",(0,s.jsx)(n.code,{children:"x.x.x.x"})]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"sudo ip route add x.x.x.x via $(ip address show dev ppp0 | grep -Po '(?<=peer )(\\b([0-9]{1,3}\\.){3}[0-9]{1,3}\\b)') dev ppp0\n\n"})}),"\n",(0,s.jsx)(n.h2,{id:"\u65b7\u7dda",children:"\u65b7\u7dda"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"sudo bash -c 'echo \"d cpcVPN\" > /var/run/xl2tpd/l2tp-control'\nipsec down L2TP-PSK\n"})}),"\n",(0,s.jsx)(n.h2,{id:"debugging",children:"Debugging"}),"\n",(0,s.jsx)(n.p,{children:"Check the logs:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"dmesg | less /var/log/xl2tpd.log\n\n"})}),"\n",(0,s.jsx)(n.p,{children:"\u7528\u5230\u7684\u6307\u4ee4"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"sudo lsof -t -i:500\nsudo kill -9 `sudo lsof -t -i:500`\n\nsudo lsof -t -i:4500\nsudo kill -9 `sudo lsof -t -i:4500`\n"})}),"\n",(0,s.jsx)(n.h6,{id:"\u53c3\u8003\u6587\u4ef6",children:"\u53c3\u8003\u6587\u4ef6"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.a,{href:"https://github.com/hwdsl2/setup-ipsec-vpn/blob/master/docs/clients.md#configure-linux-vpn-clients-using-the-command-line",children:"https://github.com/hwdsl2/setup-ipsec-vpn/blob/master/docs/clients.md#configure-linux-vpn-clients-using-the-command-line"}),"\n",(0,s.jsx)(n.a,{href:"https://github.com/feng-zh/docker-ipsec-vpn-client?tab=readme-ov-file",children:"https://github.com/feng-zh/docker-ipsec-vpn-client?tab=readme-ov-file"}),"\n",(0,s.jsx)(n.a,{href:"https://github.com/emmdim/docker-ipsec-vpn-client?tab=readme-ov-file",children:"https://github.com/emmdim/docker-ipsec-vpn-client?tab=readme-ov-file"}),"\n",(0,s.jsx)(n.a,{href:"https://github.com/r0hm1/l2tp-vpn-client",children:"https://github.com/r0hm1/l2tp-vpn-client"})]})]})}function a(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(p,{...e})}):p(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>i});var s=t(6540);const l={},r=s.createContext(l);function o(e){const n=s.useContext(r);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:o(e.components),s.createElement(r.Provider,{value:n},e.children)}}}]);